<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Escape</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0f19; color: #e9eefc; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 28px 18px 60px; }
    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 18px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    h1 { font-size: 22px; margin: 0 0 10px; letter-spacing: 0.2px; }
    p { line-height: 1.45; margin: 10px 0; color: rgba(233,238,252,0.92); }
    .stage { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px;
      background: rgba(124,92,255,0.18); border: 1px solid rgba(124,92,255,0.35); }
    .row { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    input {
      flex: 1 1 180px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: #e9eefc;
      font-size: 16px;
      letter-spacing: 4px;
      text-align: center;
    }
    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: #e9eefc;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { background: rgba(255,255,255,0.14); }
    .hint { margin-top: 12px; display: none; padding: 12px; border-radius: 12px;
      background: rgba(0,0,0,0.22); border: 1px dashed rgba(255,255,255,0.18); }
    .msg { margin-top: 12px; min-height: 22px; }
    .ok { color: #8dffb0; }
    .bad { color: #ff8d8d; }
    .small { font-size: 12px; opacity: 0.85; margin-top: 12px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; gap: 10px; }
    .linkish { background: none; border: none; padding: 0; text-decoration: underline; cursor: pointer; opacity: 0.9; }
    .topbarRight { display: flex; gap: 14px; align-items: center; }
  </style>
</head>
<body>
  <!-- Background music + SFX (put these files next to index.html):
       fantasy.mp3
       stage-solved.mp3
       treasure-reveal.mp3
  -->
  <audio id="bgMusic" loop preload="auto">
    <source src="fantasy.mp3" type="audio/mpeg">
  </audio>

  <audio id="stageSfx" preload="auto">
    <source src="stage-solved.mp3" type="audio/mpeg">
  </audio>

  <audio id="finalSfx" preload="auto">
    <source src="treasure-reveal.mp3" type="audio/mpeg">
  </audio>

  <div class="wrap">
    <div class="topbar">
      <span class="stage" id="stagePill">Stage 1 of 3</span>

      <div class="topbarRight">
        <button id="musicBtn" class="linkish" title="Toggle music">üîä Music</button>
        <button id="resetBtn" class="linkish" title="Reset progress">Reset</button>
      </div>
    </div>

    <div class="card">
      <h1 id="title">Operation: Find the Treasure</h1>
      <p id="story"></p>

      <div id="codeArea">
        <p><strong>Enter the 4-digit code:</strong></p>
        <div class="row">
          <input id="codeInput" inputmode="numeric" autocomplete="one-time-code" maxlength="4" placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" />
          <button id="unlockBtn">Unlock</button>
          <button id="hintBtn" type="button">Hint</button>
        </div>
        <div class="msg" id="msg"></div>
        <div class="hint" id="hintBox"></div>
      </div>

      <div id="finalArea" style="display:none;">
        <p id="finalText"></p>
        <p class="small">üéÅ If you want to replay later, hit Reset in the top-right.</p>
      </div>
    </div>
  </div>

  <script>
    /***** CUSTOMIZE THIS SECTION *****/
    const CONFIG = {
      // Change these to your three 4-digit codes
      codes: ["1234", "7777", "0502"],

      // Customize text per stage
      stages: [
        {
          title: "Operation: Find the Treasure",
          story: "Long ago, a relic of great power was hidden within these walls. Three seals protect it. Each seal may be broken only by finding its rune and speaking its number. The first seal awaits‚Ä¶ ‚ÄúThe first seal was forged by an ancient mage. His knowledge still lingers where words are kept and wisdom rests quietly. Seek the place where stories sleep, and you may find the rune that opens the path.‚Äù",
          hint: "The mage trusted ink and paper more than swords."
        },
        {
          title: "Locked Door, Open Mind",
          story: "The second seal lies near the heart of the home, where warmth gathers and rituals repeat each day. Count not the flames, but the habits formed by time.",
          hint: "Where mornings begin, answers tend to follow."
        },
        {
          title: "Final Lock",
          story: "The final seal was never meant to be opened alone. It rests near something shared ‚Äî a symbol of two paths joined. Only by standing where both belong can the last rune be claimed.",
          hint: "The final code is near something that belongs to *both* of you."
        }
      ],

      // The final reveal after Stage 3 is unlocked
      finalReveal: "‚ú® The seals are broken. Your treasure awaits beneath **the lovely pink holder of fantastical exercise tools**."
    };
    /***** END CUSTOMIZE SECTION *****/

    const STORAGE_KEY = "home_escape_stage"; // 0,1,2,3 (3 means complete)
    const FINAL_SFX_PLAYED_KEY = "home_escape_final_sfx_played"; // prevents replay on refresh

    const stagePill = document.getElementById("stagePill");
    const titleEl = document.getElementById("title");
    const storyEl = document.getElementById("story");
    const codeInput = document.getElementById("codeInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const hintBtn = document.getElementById("hintBtn");
    const hintBox = document.getElementById("hintBox");
    const msgEl = document.getElementById("msg");
    const resetBtn = document.getElementById("resetBtn");
    const codeArea = document.getElementById("codeArea");
    const finalArea = document.getElementById("finalArea");
    const finalText = document.getElementById("finalText");

    // Music + SFX
    const bgMusic = document.getElementById("bgMusic");
    const stageSfx = document.getElementById("stageSfx");
    const finalSfx = document.getElementById("finalSfx");
    const musicBtn = document.getElementById("musicBtn");

    let musicEnabled = true;
    let audioUnlocked = false;

    function getStage() {
      const v = Number(localStorage.getItem(STORAGE_KEY) ?? "0");
      return Number.isFinite(v) ? Math.max(0, Math.min(3, v)) : 0;
    }

    function setStage(n) {
      localStorage.setItem(STORAGE_KEY, String(n));
      render();
    }

    function render() {
      const stage = getStage();

      msgEl.textContent = "";
      msgEl.className = "msg";
      hintBox.style.display = "none";
      hintBox.textContent = "";
      codeInput.value = "";
      codeInput.focus();

      if (stage >= 3) {
        stagePill.textContent = "Complete";
        titleEl.textContent = "üéâ Escape Complete";
        storyEl.textContent = "You did it.";
        codeArea.style.display = "none";
        finalArea.style.display = "block";
        // allow **bold** in the final reveal
        finalText.innerHTML = CONFIG.finalReveal.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        return;
      }

      stagePill.textContent = `Stage ${stage + 1} of 3`;
      titleEl.textContent = CONFIG.stages[stage].title;
      storyEl.textContent = CONFIG.stages[stage].story;
      codeArea.style.display = "block";
      finalArea.style.display = "none";
    }

    function normalizeCode(s) {
      return String(s).replace(/\D/g, "").slice(0, 4);
    }

    // ---- Audio unlock + helpers ----
    function unlockAudioIfNeeded() {
      if (audioUnlocked) return;
      audioUnlocked = true;

      // "Warm up" audio elements so future play() calls succeed after a gesture
      // (Some browsers are picky; this helps.)
      [bgMusic, stageSfx, finalSfx].forEach(a => {
        try {
          a.volume = a === bgMusic ? 0.4 : 0.8;
          a.play().then(() => { a.pause(); a.currentTime = 0; }).catch(() => {});
        } catch (_) {}
      });

      // Start background music if enabled
      tryPlayMusic();
    }

    function tryPlayMusic() {
      if (!musicEnabled) return;
      bgMusic.volume = 0.4;
      bgMusic.play().catch(() => {
        // Autoplay may still be blocked; we'll keep it gesture-driven.
      });
    }

    function playStageSolvedSfx() {
      if (!audioUnlocked) return;
      try {
        stageSfx.currentTime = 0;
        stageSfx.volume = 0.9;
        stageSfx.play().catch(() => {});
      } catch (_) {}
    }

    function playFinalRevealSfxOnce() {
      if (!audioUnlocked) return;

      const already = localStorage.getItem(FINAL_SFX_PLAYED_KEY) === "1";
      if (already) return;

      localStorage.setItem(FINAL_SFX_PLAYED_KEY, "1");
      try {
        finalSfx.currentTime = 0;
        finalSfx.volume = 1.0;
        finalSfx.play().catch(() => {});
      } catch (_) {}
    }

    // Unlock audio on first interaction (mobile-friendly)
    document.addEventListener("click", unlockAudioIfNeeded, { once: true });
    document.addEventListener("keydown", unlockAudioIfNeeded, { once: true });

    // Toggle music on/off
    musicBtn.addEventListener("click", () => {
      musicEnabled = !musicEnabled;
      if (musicEnabled) {
        musicBtn.textContent = "üîä Music";
        tryPlayMusic();
      } else {
        musicBtn.textContent = "üîá Music";
        bgMusic.pause();
      }
    });

    unlockBtn.addEventListener("click", () => {
      const stage = getStage();
      const typed = normalizeCode(codeInput.value);
      codeInput.value = typed;

      if (typed.length !== 4) {
        msgEl.textContent = "Enter a 4-digit code.";
        msgEl.classList.add("bad");
        return;
      }

      if (typed === CONFIG.codes[stage]) {
        msgEl.textContent = "Unlocked ‚úÖ";
        msgEl.classList.add("ok");

        // SFX: stages 1 & 2 use stage sound; final unlock uses treasure sound.
        if (stage < 2) {
          playStageSolvedSfx();
        } else {
          // stage === 2 means they just solved the final lock -> reveal treasure
          playFinalRevealSfxOnce();
        }

        // Tiny delay for drama
        setTimeout(() => setStage(stage + 1), 550);
      } else {
        msgEl.textContent = "Nope ‚Äî try again.";
        msgEl.classList.add("bad");
      }
    });

    // Enter key submits
    codeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") unlockBtn.click();
    });

    // Keep input numeric-ish
    codeInput.addEventListener("input", () => {
      codeInput.value = normalizeCode(codeInput.value);
    });

    hintBtn.addEventListener("click", () => {
      const stage = getStage();
      hintBox.textContent = CONFIG.stages[stage].hint;
      hintBox.style.display = "block";
    });

    resetBtn.addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(FINAL_SFX_PLAYED_KEY);
      render();
    });

    render();
  </script>
</body>
</html>

